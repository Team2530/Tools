<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FRC-Timer</title>
</head>
<style>
    body {
        background-color: #231F20;
    }

    * {
        overflow-x: hidden
    }

    h1 {
        font-family: 'Courier New', Courier, monospace;
        color: white;
        font-size: 200px;
        padding: 0px;
        margin: 0px;
        text-align: center;
        display: table-cell;
        vertical-align: middle;
    }

    h2 {
        font-family: 'Courier New', Courier, monospace;
        color: white;
        font-size: 100px;
        padding: 0px;
        margin: 0px;
        text-align: center;
        vertical-align: middle;
        align-self: center;
    }

    h2.winnerannouncement {
        margin-top: 100px;
    }

    h2#winningteam {
        color: black;
    }

    .timecontainer {
        height: 50%;
        display: table;
        margin: 0 auto;
        top: 0;
    }

    .btn-group button {
        float: left;
        width: 30%;
        /* border: 5px solid black;*/
        border-color: transparent;
        margin: 1.5%;
        height: 100px;
        font-size: larger;
        border-radius: 20px;
    }

    #winner div button {
        /*position: absolute;
        bottom: 10px;*/
        display: inline-block;
        margin: 0 auto;
        text-align: center;

        width: 200px;
        border-color: transparent;
        height: 70px;
        font-size: larger;
        border-radius: 20px;
        align-self: center;
        position: absolute;
        bottom: 20px;
        left: calc(50% - 100px);
    }

    #winner div.btncontainer {
        display: flex;
        align-self: center;
        margin-top: auto;
    }

    #start {
        background-color: rgb(43, 190, 43);
    }

    #stop {
        background-color: red;
    }

    #reset {
        background-color: rgb(224, 224, 15);
    }


    #reveal {
        background-color: rgb(144, 39, 230);
    }

    #buttons {
        font-family: Georgia, 'Times New Roman', Times, serif;
        position: fixed;
        bottom: 0;
        font-size: 25px;
        padding: 0px;
        width: 100%;
    }

    #scores {
        height: 50%;
        display: table;
        width: 100%;
        margin: 0 auto;
        top: 0;
    }

    .score {
        width: 30%;
        border-radius: 20px;
        padding: 10px;
        display: table;
    }

    span {
        display: table-row;
        margin: 0;
        padding: 0;
        width: 100%;
        font-family: 'Courier New', Courier, monospace;
        text-align: center;
        font-weight: bold;
    }

    span.total {
        color: white;
        font-size: 60pt;
    }

    span.penalty {
        color: yellow;
        font-size: 30pt;
    }

    .redteam {
        background-color: #ED1C24;
        margin-left: 10%;
        float: left;
    }

    .blueteam {
        background-color: #0066B3;
        float: right;
        margin-right: 10%;

    }

    #contents {
        height: calc(100% - 100px);
        width: 100%;
        position: absolute;
        top: 0px;
    }

    #winner {
        display: inline-flex;

        background-color: #231F20;
        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        align-items: flex-start;
        flex-direction: column;
    }

    div.finalscore {
        padding: 40px 0px;
    }

    #finalscores {
        margin-top: 5%;
        height: 300px
    }

    .winningteam {
        border-color: #56ea16;
        border-width: 0px;
        border-style: solid;
        border-bottom-width: 15px;
    }

    .imagecontainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: black;
    }

    .hideoverlay {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s 1s, opacity 1s linear;
    }

    .coverimage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>

<body>
    <header class="scoring_devices"></header>
    <div id="contents">
        <div class="timecontainer">
            <h1 id="time">Time</h1>

        </div>

        <div id="scores">
            <div class="score redteam">
                <span class="total" id="rs">0</span>
                <br><span class="penalty" id="rp">-0</span>
            </div>
            <div class="score blueteam">
                <span class="total" id="bs">0</span>
                <br><span class="penalty" id="bp">-0</span>
            </div>
        </div>
    </div>
    <div id="buttons" class="btn-group">
        <button id="start" onclick="start()">Start</button>
        <button id="stop" onclick="stop()">Stop</button>
        <button id="reset" onclick="reset()">Reset</button>
        <!-- <button id="reveal" onclick="reveal()">Reveal!</button> -->
    </div>
    <div id="winner" style="display: none;">

        <h2 class="winnerannouncement"><i>The Winner is...</i></h2>
        <h2 id="winningteam">TEAM TBA</h2>
        <div id="finalscores">
            <div class="finalscore score redteam">
                <span class="total" id="fr">0</span>
                <span class="penalty" id="frp">0</span>
            </div>
            <div class="finalscore score blueteam">
                <span class="total" id="fb">0</span>
                <span class="penalty" id="fbp">0</span>
            </div>
        </div>
        <div class="btncontainer">
            <button id="reset" onclick="reset()">Reset</button>
        </div>

        <div id="revealcover" class="imagecontainer">
            <img src="./Words Green on Black.svg" class="coverimage" alt="">

        </div>

    </div>
</body>

<script>
    // Red/Blue alliance colors
    COLORS = [
        "#ED1C24",
        "#0066B3"
    ]

    // Button keymap
    KEYMAP = [
        ['s', 0, 1],
        ['s', 0, -1],
        ['s', 1, 1],
        ['s', 1, -1],
        ['p', 0, 1],
        ['p', 0, -1],
        ['p', 1, 1],
        ['p', 1, -1],
    ]
    // Scores array
    scores = [0, 0]
    // Penalties array
    penalties = [0, 0]

    // Total match time
    matchTime = 150;
    // is currently running match
    isRunning = false;

    // Last timer update time
    startTime = 0;

    // Time remaining in match
    timeRemaining = matchTime;

    // For flashing timer 
    flashCount = 0;

    // Sounds Have been played
    teleopHasNotPlayed = true;
    endgameHasNotPlayed = true;
    finalHasNotBeenPlayed = true;

    // Game is finished
    isFinished = false;


    function updateScores() {
        document.getElementById('rs').innerText = `${scores[0]}`;
        document.getElementById('rp').innerText = `-${penalties[0]}`;
        document.getElementById('bs').innerText = `${scores[1]}`;
        document.getElementById('bp').innerText = `-${penalties[1]}`;
    }

    document.addEventListener('keydown', (event) => {
        let key = event.key;
        let code = event.code;

        if (code == 'Space') {
            start();
            event.preventDefault();
        } else if (code == "Enter") {
            stop();
            event.preventDefault();
        } else if (key == 'r' && isFinished) {
            reveal();
        } else if ("12345678".includes(key)) {
            let action = KEYMAP[parseInt(key) - 1]
            console.log(`${key}: ${action}`)
            if (action[0] == 's') {
                scores[action[1]] = Math.max(0, scores[action[1]] + action[2]);
            } else {
                penalties[action[1]] = Math.max(0, penalties[action[1]] + action[2]);
            }
            updateScores();
        }

    }, false);


    document.getElementById("time").innerText = convert(timeRemaining) + ".00";
    document.getElementById("time").style.color = "#56ea16"

    function start() {
        updateScores();
        if (timeRemaining == matchTime) {
            new Audio("start.mp3").play();
        }
        startTime = Date.now()
        isRunning = true;
        document.getElementById("time").style.color = "white";
    }

    function reveal() {
        // if (timeRemaining > 0) return;
        document.getElementById("winner").setAttribute("style", "display: block");

        let finalscores = [
            scores[0] - penalties[0], scores[1] - penalties[1]];

        let winner = (finalscores[0] > finalscores[1]) ? 0 : 1;
        let winningteam_el = document.getElementById("winningteam")

        winningteam_el.style.color = COLORS[winner];
        winningteam_el.innerText = ["RED TEAM", "BLUE TEAM"][winner] + '!'



        if (finalscores[1] == finalscores[0]) {
            // Handle tie WIP
            winningteam_el.style.color = "#FFCC00";
            winningteam_el.innerText = "TIED!"
        } else {
            document.getElementById(winner == 1 ? "fr" : "fb").parentElement.classList.remove("winningteam");
            document.getElementById(winner == 0 ? "fr" : "fb").parentElement.classList.add("winningteam");
        }
        document.getElementById("fr").innerText = `${finalscores[0]}`;
        document.getElementById("frp").innerText = `Penalty: ${penalties[0]}`;
        document.getElementById("fb").innerText = `${finalscores[1]}`;
        document.getElementById("fbp").innerText = `Penalty: ${penalties[1]}`;

        setTimeout(() => document.getElementById("revealcover").classList.add("hideoverlay"), 2000);
        // WIP
    }

    function stop() {
        isRunning = false;
    }

    function reset() {
        if (!confirm("Are you sure you want to reset? Scores will be reset.")) {
            return;
        }
        document.getElementById("revealcover").classList.remove("hideoverlay")
        document.getElementById("winner").setAttribute("style", "display: none");
        scores = [0, 0];
        penalties = [0, 0];
        updateScores();
        stop();
        timeRemaining = matchTime;
        document.getElementById("time").innerText = convert(timeRemaining) + ".00";
        document.getElementById("time").style.color = "#56ea16";
        teleopHasNotPlayed = true;
        endgameHasNotPlayed = true;
        finalHasNotBeenPlayed = true;
        isFinished = false;
    }

    function updateTime() {
        timeRemaining -= (Date.now() - startTime) / 1000;
        startTime = Date.now();
    }

    function convert(seconds) {
        extraZero = "";
        fraction = Math.floor(seconds / 60)
        if (seconds - 60 * fraction < 10) {
            extraZero = "0"
        }
        return ("" + fraction + ":" + extraZero + (seconds - 60 * fraction)).substring(0, 7);
    }

    function flash() {
        flashCount++;
        if (flashCount >= 75) {
            currentColor = document.getElementById("time").style.color;
            if (currentColor == "white") {
                document.getElementById("time").style.color = "red";
            } else {
                document.getElementById("time").style.color = "white";
            }

            flashCount = 0;
        }

    }

    /*Main Funciton (does all updates)*/
    function main() {
        if (isRunning) {
            updateTime();
            document.getElementById("time").innerText = convert(timeRemaining);
        }

        if (timeRemaining < 120 && teleopHasNotPlayed) {
            new Audio("teleop.mp3").play();
            teleopHasNotPlayed = false;
        }

        if (timeRemaining < 30 && endgameHasNotPlayed) {
            new Audio("whistle.mp3").play();
            document.getElementById("time").style.color = "yellow";
            endgameHasNotPlayed = false;
        }

        if (isRunning && timeRemaining <= 0 && finalHasNotBeenPlayed) {
            new Audio("endbuzzer.mp3").play();
            document.getElementById("time").style.color = "red";
            finalHasNotBeenPlayed = false;
            isFinished = true;
        }

        if (timeRemaining <= 0) {
            document.getElementById("time").innerText = "0:00.00";
            stop();
            flash();
        }
    }

    setInterval(main, 10)


</script>

</html>